---
import Layout from '../layouts/Layout.astro'
import { questionsSet3aa, questionsSet3ab, questionsSet3ba, questionsSet3bb } from '../data/test3-questions'
---

<Layout title="診断ページ 3/3">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">
        診断ページ 3/3
      </h1>
      <p class="text-center text-gray-600 mb-8">
        最後の質問です。次の選択肢の中から一つ選んでください。
      </p>

      <form id="test3Form" class="space-y-8">
        <div id="questionsContainer">
          <!-- 質問はJavaScriptで動的に挿入 -->
        </div>

        <div class="text-center mt-8">
          <button
            type="submit"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-md"
          >
            診断結果を見る
          </button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script>
  import { getStageData, saveStageData, calculateScore } from '../scripts/diagnosis-client'
  import { questionsSet3aa, questionsSet3ab, questionsSet3ba, questionsSet3bb } from '../data/test3-questions'

  // 第1・2段階のデータを取得
  const stage1Data = getStageData(1)
  const stage2Data = getStageData(2)
  
  if (!stage1Data || !stage2Data) {
    window.location.href = '/test'
  }

  const isGeneral = stage2Data!.isGeneral
  const stage2Score = stage2Data!.score

  // 質問セットを決定
  let questions
  if (isGeneral) {
    questions = stage2Score >= 25 ? questionsSet3aa : questionsSet3ab
  } else {
    questions = stage2Score >= 15 ? questionsSet3ba : questionsSet3bb
  }

  // 質問を動的に生成
  const container = document.getElementById('questionsContainer')!
  questions.forEach((question, index) => {
    const questionHtml = `
      <div class="bg-gray-50 rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4 text-gray-800">
          問題${index + 1}: ${question.text}
        </h2>
        <div class="space-y-3">
          ${question.options.map(option => `
            <label class="flex items-start space-x-3 cursor-pointer hover:bg-gray-100 p-3 rounded transition duration-200">
              <input
                type="radio"
                name="${question.id}"
                value="${option.value}"
                required
                class="mt-1 text-blue-600 focus:ring-blue-500"
              />
              <span class="text-gray-700 leading-relaxed">
                ${option.text}
              </span>
            </label>
          `).join('')}
        </div>
      </div>
    `
    container.insertAdjacentHTML('beforeend', questionHtml)
  })

  // フォーム送信処理
  const form = document.getElementById('test3Form') as HTMLFormElement
  form.addEventListener('submit', (e) => {
    e.preventDefault()
    
    const formData = new FormData(form)
    const score = calculateScore(formData, questions.map(q => q.id))
    
    saveStageData(3, {
      score,
      answers: Object.fromEntries(formData),
      stage1Score: stage1Data!.score,
      stage2Score: stage2Data!.score,
      isGeneral
    })
    
    window.location.href = '/result'
  })
</script>
