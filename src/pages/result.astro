---
import Layout from '../layouts/Layout.astro'
import { authors } from '../data/authors'
---

<Layout title="診断結果">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8 text-center">
      <h1 class="text-4xl font-bold mb-4 text-gray-800">
        診断結果
      </h1>

      <div id="resultCard" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-8 mb-8">
        <!-- 結果はJavaScriptで動的に挿入 -->
      </div>

      <div id="descriptionCard" class="bg-gray-50 rounded-lg p-6 mb-8 text-left">
        <!-- 説明はJavaScriptで動的に挿入 -->
      </div>

      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md">
          もう一度診断する
        </a>
        <a href="/list" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md">
          他の文豪を見る
        </a>
        <a id="detailLink" href="#" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md">
          詳細を見る
        </a>
      </div>

      <div class="mt-8 p-4 bg-yellow-50 rounded-lg">
        <p class="text-sm text-gray-600">
          この診断は娯楽目的のものです。実際の性格や才能を保証するものではありません。
        </p>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { getStageData, clearDiagnosisData } from '../scripts/diagnosis-client'
  import { authors } from '../data/authors'
  import { diagnose } from '../utils/diagnosis'

  // 各段階のデータを取得
  const stage3Data = getStageData(3)
  
  if (!stage3Data) {
    window.location.href = '/test'
  }

  // 診断を実行
  const authorId = diagnose(
    stage3Data!.stage1Score,
    stage3Data!.stage2Score,
    stage3Data!.score,
    stage3Data!.isGeneral
  )
  
  const author = authors.find(a => a.id === authorId) || authors[0]

  // タイトルを更新
  document.title = `診断結果: ${author.name}`

  // 結果カードを表示
  const resultCard = document.getElementById('resultCard')!
  resultCard.innerHTML = `
    <h2 class="text-3xl font-bold mb-2">
      ${author.name}
    </h2>
    <p class="text-xl">
      ${author.type}
    </p>
  `

  // 説明カードを表示
  const descriptionCard = document.getElementById('descriptionCard')!
  descriptionCard.innerHTML = `
    <h3 class="text-xl font-semibold mb-4 text-gray-800">
      ${author.name}について
    </h3>
    <p class="text-gray-700 leading-relaxed">
      ${author.description || `${author.name}は${author.type}として知られています。詳細な性格分析は準備中です。`}
    </p>
  `

  // 詳細リンクを設定
  const detailLink = document.getElementById('detailLink') as HTMLAnchorElement
  detailLink.href = `/authors/${author.id}`

  // 診断データをクリア（次回の診断のため）
  clearDiagnosisData()
</script>
